<HTML>
<HEAD>
    <link rel="stylesheet" type="text/css" href="index.css">
</HEAD>

<BODY>

    <div class=menuContainer>

        <div id="signDiv" style="display:table-cell">
            <p>Username:</p>
            <input id="signDiv-username" type="text"><br>
            <p>Password:</p>
            <input id="signDiv-password" type+"password"><br>
            <button id="signDiv-signIn">Sign in</button>
            <button id="signDiv-signUp">Sign up</button>
            <button id="skipSign">Play Offline</button>
        </div>



        <div id='mainMenu'>

            <div id='top'>
                <img src='resources/Play.png' id='Play' onclick='playOptions()'>
            </div>

            <div id='other'>
                <img src='resources/BrowseLevels.png' id='BrowseLevels' onclick='levelBrowser()'></img>
            </div>

            <div id='other'>
                <img src='resources/LevelEditor.png' id='LevelEditor' onclick='levelEditorOptions()'></img>
            </div>

            <div id='bottom'>
                <img src='resources/Options.png' id='Options' onclick='options()'></img>
            </div>

        </div>


        <div id='playOptions'>

            <div id='top'>
                <img src='resources/NewGame.png' id='NewGame' onclick='playNewGame()'></img>
            </div>

            <div id='other'>
                <img src='resources/LoadGame.png' id='LoadGame'></img>
            </div>

            <div id='bottom'>
                <img src='resources/Back.png' id='Back' onclick='back()'></img>
            </div>

        </div>

        <div id='levelEditorOptions'>

            <div id='top'>
                <img src='resources/NewLevel.png' id='NewLevel' onclick="newLevel()"></img>
            </div>

            <div id='other'>
                <img src='resources/LoadLevel.png' id='LoadLevel'></img>
            </div>

            <div id='bottom'>
                <img src='resources/Back.png' id='Back' onclick='back()'></img>
            </div>

        </div>

        <div id='levelBrowser'>

            <table id='holder'>
                <tr>
                    <td>
                        <table id='title'>
                            <col width="395">
                            <col width="200">
                            <col width="200">
                            <tr>
                                <th><img src='resources/Title.png' id='left'></img></th>
                                <th><img src='resources/Author.png' id='left'></img></th>
                                <th><img src='resources/Created-On.png' id='left'></img></th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id='scroll'>
                            <table id='level'>
                                <col width="400">
                                <col width="200">
                                <col width="200">
                                <tbody id="levelTable">
                                    <tr>
                                        <td>Level 1</td>
                                        <td>The Wizard</td>
                                        <td>March 5th</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            </table>
            <br>
            <div id='bottom'>
                <img src='resources/Back.png' id='Back' onclick='back()'></img>
            </div>
        </div>


        <div id=settings>
            <table id="holder">
                <tbody>
                    <tr>
                        <td>
                            <div id="scroll">
                                <table id='gameSettings'>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <br>
            <img src='resources/Back.png' id='Back' onclick='back()'></img>
        </div>

        <div id="gameDiv" style="display:none; height:720px; width:1280px;  position: absolute; margin: auto; top: -16px;right: 0; left: -16px; bottom: 0;overflow:hidden; "></div>
        <div id="editor" style="display:none">
            <div id="gameDiv" style=" width: 720px; height: 480px; overflow:scroll;   margin:20px; float:left">
                <canvas id="canvas" style="background: #fff" width=720px height=480px oncontextmenu="return false;"></canvas>
            </div>
            <div id="side" class=editor style="margin:20px; width:auto; float:right">
                <div id='buttons' style="margin:5px">
                    <img src='resources/Tiles.png' id='selectTiles' onclick='tilesOptions()'></img>
                    <img src='resources/Creature.png' id='selectCreature' onclick='creatureOptions()'></img>
                    <img src='resources/Entity.png' id='selectEntity' onclick='entityOptions()'></img>
                </div>







                <hr noshade>

                <div id='tiles'>
                    <table id='select'>
                        <tbody></tbody>
                    </table>
                </div>

                <div id='creature'>
                    <table id='select'>
                        <tbody></tbody>
                    </table>
                </div>

                <div id='entity'>
                    <table id='select'>
                        <tbody></tbody>
                    </table>
                </div>

                <hr noshade>

                <table id='inputs'>
                    <tr>
                        <td>
                            <h5>Background:</h5>
                            <select id="background" onchange="setBackground(this)">
                                <option value="B1">B1</option>
                                <option value="B2">B2</option>
                                <option value="B3">B3</option>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h5>Map Width:</h5>
                            <input id="mapW" type="number" name="width" min="0" max=""> <!–– Set Max ––>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h5>Map Height:</h5>
                            <input id="mapH" type="number" name="height" min="0" max=""> <!–– Set Max ––>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h5>Spawn Point (X-Coordinate):</h5>
                            <input type="number" name="X" min="0" max=""> <!–– Set Max ––>
                            <br>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h5>Spawn Point (Y-Coordinate):</h5>
                            <input type="number" name="Y" min="0" max=""> <!–– Set Max ––>
                            <br>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h5>Gravity:</h5>
                            <input type="range" name="points" min="0" max="5" oninput="setBackground(this.value)" ">
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <h5>Moveset:</h5>
                            <input type="number" name="move" min="0" max=""> <!–– Set Max ––>
                            <br>
                        </td>
                    </tr>


                </table>
                <input type="button" name="Load" value="Load" onclick="loadLevel()">
                <input type="button" name="Save" value="Save" onclick="saveLevel()">
            </div>
        </div>
    </div>

    <script src="http://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript" src="js/config.js"></script>
    <script type="text/javascript" src="js/entities.js"></script>
    <script type="text/javascript" src="js/gun.js"></script>
    <script type="text/javascript" src="js/level.js"></script>
    <script type="text/javascript" src="js/sprite.js"></script>
    <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/overworld.js"></script>
    <script type="text/javascript" src="js/playermods.js"></script>
    <script type="text/javascript" src="js/server.js"></script>
    <script type="text/javascript" src="js/editor.js"></script>



    <script type="text/javascript">
        var sizeSettings = [1280, 720];


        offLinePlay.onclick = function () {
            document.getElementById("signDiv").style.display = "none";
            loadCurretUser();
        }

        function playOptions() {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("playOptions").style.display = "table-cell";
        }

        function playNewGame() {
            if (overWorld == undefined) {
                loadCurretUser();
            } else {
                document.getElementById("mainMenu").style.display = "none";
                document.getElementById("gameDiv").style.display = "table-cell";
                loaded = true;
                overWorld.music.play();
            }
        }

        function levelBrowser() {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("levelBrowser").style.display = "table-cell";
            loadLevelsList();
        }

        function levelEditorOptions() {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("levelEditorOptions").style.display = "table-cell";
        }

        function options() {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("settings").style.display = "table-cell";
        }

        function back() {
            document.getElementById("playOptions").style.display = "none";
            document.getElementById("levelEditorOptions").style.display = "none";
            document.getElementById("levelBrowser").style.display = "none";
            document.getElementById("settings").style.display = "none";
            document.getElementById("gameDiv").style.display = "none";
            document.getElementById("mainMenu").style.display = "table-cell";
        }

        function tilesOptions() {
            document.getElementById("creature").style.display = "none";
            document.getElementById("entity").style.display = "none";
            document.getElementById("tiles").style.display = "inline-block";
        }

        function creatureOptions() {
            document.getElementById("entity").style.display = "none";
            document.getElementById("tiles").style.display = "none";
            document.getElementById("creature").style.display = "inline-block";
        }

        function entityOptions() {
            document.getElementById("creature").style.display = "none";
            document.getElementById("tiles").style.display = "none";
            document.getElementById("entity").style.display = "inline-block";
        }

        function newLevel() {
            document.getElementById("levelEditorOptions").style.display = "none";
            document.getElementById("editor").style.display = "table-cell";
            var canvas = document.getElementById("canvas")
            elemt = new Editor(canvas);
        }

        function toLevel() {
            document.getElementById("levelBrowser").style.display = "none";
            document.getElementById("gameDiv").style.display = "table-cell";
        }

        function selectCharacter() {
            var char = document.getElementById("character");
        }

        function setBackground() {
            var background = document.getElementById("background");
        }

        function setWidth(w) {

        }

        /*loadLevelsList.onclick = function () {
            loadLevelsList();
        }*/

        function setHeight(h) {

        }


        function setSpawnX(x) {

        }

        function setSpawnY(y) {

        }

        function setGravity(g) {

        }

        //Story mode initialization
        //storyMode.onclick = function () {
        //    loadUserDatabase();
        //}
        //Test database
        //    testDatabase.onclick = function () {
        //        testDatabaseFunct();
        //    }

        // pushtodatabase.onclick = function () {
        // 	pushdatabasefunct();
        // }
        //game

        var canvas;
        var container = document.getElementById("gameDiv");

        function create(type, id, left, top, width, height) {
            var elem = document.createElement(type);
            elem.id = id;
            if (left != 0) { elem.style.left = left; }
            if (top != 0) { elem.style.top = top; }
            if (height != 0) {
                elem.height = height;
            }
            if (width != 0) {
                elem.width = width;
            }
            if (id != "bg") {
                container.appendChild(elem);
            }
            return elem;
        }

        var neededFiles = ["tiles.json", "entities.json", "weapons.json"];
        var loaded = false;

        var conf;
        loadJSONFile(function (response) {
            conf = CONFIG(response);
        }, "/client/js/config.json");


        var refreshLevelsTable = function () {
            console.log("Inside refresh");
            var levelsTable = document.getElementById('levelTable');

            while (levelsTable.firstChild) {
                levelsTable.removeChild(levelsTable.firstChild);
            }
        }

        var loadLevelsList = function () {
            refreshLevelsTable();
            var levelsTable = document.getElementById('levelTable');
            loadDB('level', function (data) {
                var levels;

                if (data == null) {
                    return;
                }

                if (data.constructor === Array) {
                    levels = data;
                }
                else {
                    levels = [data];
                }

                console.log(levels);
                for (var level of levels) {
                    var levelName = level.levelName;
                    var author = level.user;
                    var dateCreated = level.dateCreated;

                    console.log("inside for");

                    var levelRow = levelsTable.insertRow(levelsTable.rows.length);
                    levelRow.setAttribute("id", level.id);


                    var levelNameCell = levelRow.insertCell(0);
                    levelNameCell.innerHTML = levelName;

                    var authorCell = levelRow.insertCell(1);
                    authorCell.innerHTML = author;

                    var dateCreatedCell = levelRow.insertCell(2);
                    dateCreatedCell.innerHTML = dateCreated;


                    levelRow.onclick = function () {
                        console.log(this.getAttribute("id"))
                        loadDBFromID("level", this.getAttribute("id"), function (response) {
                            toLevel();
                            overWorld.toMapFromDB(response);
                        });
                    }
                }
            });
        }



        var map;
        //achievement array
        function loadUserDatabase() {
            console.log("Inside loadUserDatabase " + playerUsername);
            loadDBFromID('player', playerUsername, function (response) {
                console.log("Inside loaduserdatabase " + JSON.stringify(response[0]));
                loadGame(false, response[0]);
            });
        }

        //needs to be fetched from the db and put into a json like file
        function loadCurretUser() {
            loadJSONFile(function (response) {
                loadGame(false, JSON.parse(response));
            }, "/client/resources/player.json");
        }


        var loadMenu = function () {
            signDiv.style.display = 'none';
            gameDiv.style.display = 'none';
            menuDiv.style.display = 'table-cell';
        }

        function loadNeeded() {
            for (var x of neededFiles) {
                var resource = "/client/resources/";
                if (x == "weapons.json") {
                    loadJSONFile(function (response) {
                        loadWeapons(response);
                    }, resource + x);
                }
                else {
                    loadJSONFile(function (response) {
                        loadSprites(response, canvas);
                    }, resource + x);
                }
            }
        }

        function loadGame(reload, player) {
            //setting the divs correctly
            if (!reload) {
                loadNeeded();
            }
            var handler = 0;
            //loading into the overworld
            loadOverworld(player, function (m) {
                loadJSONFile(function (response) {
                    loadJSONFile(function (r) {
                        loadJSONFile(function (t) {
                            if (handler == 5) {
                                console.log("FATAL ERROR HAS OCCURD. QUICK RUN");
                                location.reload();
                            }
                            m.shop = loadShop(player, JSON.parse(t));
                            m.loadCharacterSelect(JSON.parse(response), JSON.parse(r), player, JSON.parse(t));
                            m.music.stop();
                            handler++;
                        }, "/client/resources/values.json");

                    }, "/client/resources/characters.json");
                }
                    , "/client/resources/overWorldCharacters.json");
            });
        }

        var overWorld;
        var interval = setInterval(update, 1000 / 60);

        function update() {
            if (loaded) {
                canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                if (overWorld.doingDialog) {
                    //this needs fixing
                    if (overWorld.diag[overWorld.dialog].popUp.y != canvas.height) {
                        overWorld.diag[overWorld.dialog].popUp.y = canvas.height - 300;
                    }
                    overWorld.diag[overWorld.dialog].doDialog();
                } else if (!overWorld.handleBuildings()) {
                    if (!overWorld.doingDialog) {
                        map.doTick();
                    }
                }
                if (overWorld.inExitMenu) {
                    overWorld.exit.menu();
                }
            }
        }

        //keyboard handling
        document.onkeydown = function (e) {
            e = e || window.event;
            var charCode = (typeof e.which == "number") ? e.which : e.keyCode;
            if (charCode && loaded) {
                if (overWorld.inExitMenu) {
                    overWorld.exit.navigate(conf[charCode]);
                    return true;
                }
                if (overWorld.doingDialog) {
                    if (conf[charCode] == "action") {
                        overWorld.diag[overWorld.dialog].nextText();
                    }
                }else  if (!overWorld.handleKeys(conf[charCode], true)) {
                    if (!overWorld.doingDialog) {
                        map.getPlayer().doMove(conf[charCode], true);
                    }
                }
            } else if (isChanging) {
                changeKey(charCode);
            }
        };

        document.onkeyup = function (e) {
            e = e || window.event
            var charCode = (typeof e.which == "number") ? e.which : e.keyCode;
            if (charCode && loaded) {
                if (map != undefined) {
                    map.getPlayer().doMove(conf[charCode], false);
                } else if (overWorld.inMuseum) {
                    overWorld.handleKeys(conf[charCode], false);
                }
            }
        };

        //only needed for some debugging ..
        document.onmousedown = function (e) {
            e = e || window.event;
            if (loaded) {
                var poss = getMousePos(canvas, e);
                console.log(poss.x + " " + poss.y);
            }
        }

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function msToTime(duration) {
            var milliseconds = parseInt((duration % 1000) / 100)
                , seconds = parseInt((duration / 1000) % 60)
                , minutes = parseInt((duration / (1000 * 60)) % 60)
                , hours = parseInt((duration / (1000 * 60 * 60)) % 24);
            hours = (hours < 10) ? "0" + hours : hours;
            minutes = (minutes < 10) ? "0" + minutes : minutes;
            seconds = (seconds < 10) ? "0" + seconds : seconds;
            return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
        }
        window.onload = loadCurretUser();
    </script>


</BODY>
</HTML>

