<div id="main" style="height:720px; width:1280px;  position: absolute; margin: auto; top: 0;right: 0; left: 0; bottom: 0;border: 2px solid;">

    <div id="form-wrapper">

        <div id="signDiv">
            username: <input id="signDiv-username" type="text"><br>
            password: <input id="signDiv-password" type+"password">
            <button id="signDiv-signIn">Sign in</button>
            <button id="signDiv-signUp">Sign up</button> &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
            <button id="skipSign">Play Offline</button>
        </div>
    </div>
    <div id="menuDiv" style="display:none;overflow:hidden;">
        <button id="playStoryMode">Story Mode</button>
        <button id="loadLevelsList">User Created Levels</button>
        <button id="changeSettings">Settings</button>
        
        <button id="testdatabase">test database</button>
		<button id="pushtodatabase">push to database</button>
    </div>
    <div id="levelsList"></div>

    <div id="gameDiv" style="display:none;overflow:hidden; " />


</div>
<link rel="stylesheet" type="text/css" href="resources/login-middle.css">
<script src="http://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript" src="js/config.js"></script>
<script type="text/javascript" src="js/entities.js"></script>
<script type="text/javascript" src="js/gun.js"></script>
<script type="text/javascript" src="js/level.js"></script>
<script type="text/javascript" src="js/sprite.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/overworld.js"></script>
<script type="text/javascript" src="js/playermods.js"></script>
<script type="text/javascript" src="js/database.js"></script>




<script>
    var sizeSettings = [1280, 720];


    //codes for login

    var socket = io();

    //login menu
    var signDiv = document.getElementById('signDiv');
    var signDivUsername = document.getElementById('signDiv-username');
    var signDivSignIn = document.getElementById('signDiv-signIn');
    var signDivSignUp = document.getElementById('signDiv-signUp');
    var signDivPassword = document.getElementById('signDiv-password');

    //main menu after sign-in
    var menuDiv = document.getElementById('menuDiv');
    var storyMode = document.getElementById('playStoryMode');
    var loadLevelsList = document.getElementById('loadLevelsList');
    var settings = document.getElementById('changeSettings');

    var offLinePlay = document.getElementById("skipSign");

    //Test database button
    var testDatabase = document.getElementById("testdatabase");
	
	//Push to database test
	var pushtodatabase = document.getElementById("pushtodatabase");

    var playerUsername;

    signDivSignIn.onclick = function () {
        socket.emit('signIn', { username: signDivUsername.value, password: signDivPassword.value });
    }
    signDivSignUp.onclick = function () {
        socket.emit('signUp', { username: signDivUsername.value, password: signDivPassword.value });
    }
    socket.on('signInResponse', function (data) {
        if (data.success) {
            playerUsername = signDivUsername.value;
            console.log(playerUsername);
            loadMenu();
        } else
            alert("Sign in unsuccessul.");
    });
    socket.on('signUpResponse', function (data) {
        if (data.success) {
            alert("Sign up successul.");
        } else
            alert("Sign up unsuccessul.");
    });
    offLinePlay.onclick = function () {
        loadCurretUser();
    }

    loadLevelsList.onclick = function () {
        loadLevelsListFunct();
    }

    //Story mode initialization
    storyMode.onclick = function () {
        loadUserDatabase();
    }

    //Test database
    testDatabase.onclick = function () {
        testDatabaseFunct();
    }
	
	pushtodatabase.onclick = function () {
		pushdatabasefunct();
	}



    //game

    var canvas;
    var container = document.getElementById("gameDiv");

    testDatabaseFunct = function () {
        console.log("test database: before loadDB");
        loadDB('player', function (data) {
            console.log("test database");
            console.log(data[0].id);
        });
    }
	
	var playerobjecttest = 
        {
            "id": "player1",
            "currentCharacter": 667,
            "achievements": [],
            "unlockedCharacters": [667],
            "money": 0,
            "weapons": [
                {
                    "id": 1,
                    "damageMult": 1,
                    "speedMult": 1,
                    "equippedImpact": "explode",
                    "availableImpact": ["explode", "die"]
                },
                {
                    "id": 2,
                    "damageMult": 1,
                    "speedMult": 1,
                    "equippedImpact": "ricochet",
                    "availableImpact": ["ricochet"]
                }
            ],
            "equipped": [1, 2],
            "artifacts": [],
            "storyProgress": [],
            "levelsMade": [],
            "killcount": 0,
            "timeplayed": 0
        }

	
	
	pushdatabasefunct = function () {
		console.log("push to database before writeDB");
		writeDB('player', playerobjecttest);
	}
	
	


    function create(type, id, left, top, width, height) {
        var elem = document.createElement(type);
        elem.id = id;
        if (left != 0) { elem.style.left = left; }
        if (top != 0) { elem.style.top = top; }
        if (height != 0) {
            elem.height = height;
        }
        if (width != 0) {
            elem.width = width;
        }
        if (id != "bg") {
            container.appendChild(elem);
        }
        return elem;
    }

    var neededFiles = ["tiles.json", "entities.json", "config.json", "weapons.json"];



    var loaded = false;
    function loadJSONFile(callback, file) {
        socket.emit('loadJSON', {
            fileName: file
        });

        socket.on(file, function (data) {
            callback(data.toString());
        });

    }
    var conf;



    var loadLevelsListFunct = function () {
        menuDiv.style.display = 'none';
        /*
        loadDB('levelsList', function (data) {
            console.log(data);
        });*/
        var levelsList = document.getElementById('levelsList');
        var levelRow = document.createElement("P");
        var t = document.createTextNode("Desert      Brandon     March 1st, 2018");
        levelRow.appendChild(t);
        levelsList.appendChild(levelRow);
    }




    var map;
    //achievement array
    var ach = [];

    function loadUserDatabase() {
        console.log("Inside loadUserDatabase " + playerUsername);
        loadDBFromID('player', playerUsername, function (response) {
            console.log("Inside loaduserdatabase" + JSON.stringify(response[0]));
            loadGame(false, response[0]);
        });
    }

    //needs to be fetched from the db and put into a json like file
    function loadCurretUser() {
        loadJSONFile(function (response) {
            console.log("inside loadcurrentuser"+ response);
            loadGame(false, JSON.parse(response));
        }, "/client/resources/player.json");
    }

    function getMap(newMap) {
        map = newMap;
        //get something for load
        loadAchievements();
    };

    function loadAchievements() {
        loadJSONFile(function (response) {
            for (var ac of JSON.parse(response)) {
                var a = new Achievement(ac, map);
                document.addEventListener(a.type, function (e) {
                    for (var a of ach[e.type]) {
                        a.function();
                    }
                });
                if (ach[a.type] == undefined) {
                    ach[a.type] = [];
                }
                ach[a.type].push(a);
            }
        }, "/client/resources/achievements.json");




    }

    var loadMenu = function () {
        signDiv.style.display = 'none';
        gameDiv.style.display = '';
        menuDiv.style.display = 'block';
    }


    function loadNeeded(player) {
        for (var x of neededFiles) {
            var resource = "/client/resources/";
            if (x == "config.json") {
                resource = "/client/js/";
                conf =
                    loadJSONFile(function (response) {
                        conf = CONFIG(response);
                    }, resource + x);
            } else if (x == "weapons.json") {
                loadJSONFile(function (response) {
                    loadWeapons(response);
                }, resource + x);
            }
            else {
                loadJSONFile(function (response) {
                    loadSprites(response, canvas);
                }, resource + x);
            }
        }
    }
    function getOverWorld(newMap) {
                overWorld = newMap;
            }

    function loadGame(reload, player) {
        //setting the divs correctly
        signDiv.style.display = 'none';
        gameDiv.style.display = '';
        if (!reload) {
            loadNeeded(player);
        }

        //loading the test map
        loadOverworld(player, function (m) {

            loadJSONFile(function (response) {
                m.shop = loadShop(player);
                loadJSONFile(function (r) {
                    m.loadCharacterSelect(JSON.parse(response), JSON.parse(r), player);
                }, "/client/resources/characters.json");
            }
                , "/client/resources/overWorldCharacters.json");
        });
    }

    var overWorld;
    var interval = setInterval(update, 1000 / 60);

    function update() {
        if (loaded) {
            canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
            if (!overWorld.handleBuildings()) {
                if (!map.doingDialog) {
                    map.doTick();
                } else if (map.doingDialog) {
                    //this needs fixing
                    if (overWorld.diag[map.startDialog == -1 ? map.endDialog : map.startDialog].popUp.y != canvas.height) {
                        overWorld.diag[map.startDialog == -1 ? map.endDialog : map.startDialog].popUp.y = canvas.height - 300;
                    }

                    overWorld.diag[map.startDialog == -1 ? map.endDialog : map.startDialog].doDialog();
                }
            }
        }
    }


    document.onkeydown = function (e) {
        e = e || window.event;
        var charCode = (typeof e.which == "number") ? e.which : e.keyCode;
        if (charCode && loaded) {
            if (!overWorld.handleKeys(conf[charCode])) {
                if (!map.doingDialog) {
                    map.getPlayer().doMove(conf[charCode], true);
                } else if (map.doingDialog) {
                    if (conf[charCode] == "action") {
                        overWorld.diag[map.startDialog == -1 ? map.endDialog : map.startDialog].nextText();
                    }
                }
            }
        }
    };

    document.onkeyup = function (e) {
        e = e || window.event
        var charCode = (typeof e.which == "number") ? e.which : e.keyCode;
        if (charCode && loaded && map != undefined) {
            map.getPlayer().doMove(conf[charCode], false);
        }
    };


    //only needed for some debugging ..
    document.onmousedown = function (e) {
        e = e || window.event;
        if (loaded) {
            var poss = getMousePos(canvas, e);
            console.log(poss.x + " " + poss.y);
        }
    }

    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }



    function msToTime(duration) {
        var milliseconds = parseInt((duration % 1000) / 100)
            , seconds = parseInt((duration / 1000) % 60)
            , minutes = parseInt((duration / (1000 * 60)) % 60)
            , hours = parseInt((duration / (1000 * 60 * 60)) % 24);

        hours = (hours < 10) ? "0" + hours : hours;
        minutes = (minutes < 10) ? "0" + minutes : minutes;
        seconds = (seconds < 10) ? "0" + seconds : seconds;

        return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
    }


    //window.onload = loadCurretUser();

</script>
<body>

</body>
